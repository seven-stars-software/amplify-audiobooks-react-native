# Work Journal - December 2, 2025

**Developer:** Jackson Callaway (@jcksncllwy)
**Focus:** Fastlane Release Automation (Issue #10)

---

## Complete Fastlane Setup

**Fastlane Installation & Configuration**
- Installed Fastlane via Gemfile
- Created comprehensive Fastfile with lanes for:
  - Version bumping across all platforms (package.json, app.json, Android, iOS)
  - Android AAB builds with keystore signing
  - iOS IPA builds with App Store Connect API
  - Combined release workflow
  - Git tagging and commit automation
- Added NPM scripts for convenient release commands
- Auto-generated README.md documentation

**Google Play Service Account Setup**
- Created Google Cloud project: `amplifyaudiobooks-api`
- Enabled Google Play Android Developer API
- Created service account: `fastlane-release@amplifyaudiobooks-api.iam.gserviceaccount.com`
- Downloaded JSON key and stored in `android/google-play-key.json`
- Granted admin permissions in Play Console (Users and permissions)
- Updated documentation with 2025 Google Play setup process (old docs were outdated)

**App Store Connect API Setup**
- Generated API Key in App Store Connect
- Key ID: `6ZN29XPT4Z`
- Issuer ID: `b42c1557-1cbc-4d99-82e9-26b28023c64b`
- Downloaded and stored key file in `ios/AuthKey_6ZN29XPT4Z.p8`
- Provides full API access (including build listings, unlike app-specific passwords)
- Commented out app-specific password to avoid authentication conflicts

## Bug Fixes

**Bundle Identifier Consistency**
- Found inconsistency: app.json and Appfile had `org.reactjs.native.example.AmplifyAudiobooks`
- Correct bundle ID verified in App Store Connect: `com.sevenstar.amplify`
- Fixed both files to match actual bundle ID

**Android Build Signing Issue**
- Initial Android build failed due to Fastfile overriding signing configuration
- Problem: ENV variables for keystore were passed to gradle, creating invalid path
- Solution: Removed signing properties override from Fastfile
- Now uses existing `keystore.properties` configuration
- Fixed keystore path in keystore.properties (was doubled: `app/app/...`)

**Documentation Updates**
- Fixed all references from `.env` to `.env.development` (actual file used)
- Updated Google Play setup with 2025 process (Settings → Users and permissions)
- Changed hardcoded ANDROID_KEY_ALIAS to placeholder per user feedback

## Testing Results

**Version Bump Testing**
- Tested bump from 2.2.0 → 2.2.1, build 7 → 8
- ✅ package.json updated correctly
- ✅ app.json updated correctly
- ✅ Android build.gradle versionCode and versionName updated
- ✅ iOS project files updated via agvtool
- Successfully restored back to 2.2.0/build 7

**Android Build Testing**
- ✅ AAB build successful: 41MB output
- ✅ File location verified: `android/app/build/outputs/bundle/release/app-release.aab`
- Build time: ~2 minutes

**iOS Build Testing**
- ✅ IPA build successful: 21MB output
- ✅ File location verified: `build/AmplifyAudiobooks.ipa`
- Build time: ~9 minutes
- Some deprecation warnings but no errors

**Not Yet Tested**
- ⏳ Actual deployment to Google Play Console (`fastlane android deploy`)
- ⏳ Actual deployment to App Store Connect (`fastlane ios deploy`)
- ⏳ Full release workflow with manual CHANGELOG.md step
- Plan: Test deployment with next patch version (2.2.1)

## Branch & PR Management

- Created `feature/fastlane-automation` branch
- Opened PR #12 with comprehensive documentation: https://github.com/seven-stars-software/amplify-audiobooks-react-native/pull/12
- Stashed android/app/build.gradle versionCode change (3 → 7) for main branch
- Switched to main and committed versionCode update separately
- Committed Fastfile fix with auto-generated README.md

## Available Commands

```bash
# Version bumping
npm run release:version version:X.Y.Z build:N

# Building
npm run release:build-android
npm run release:build-ios

# Deploying (untested)
npm run release:deploy-android
npm run release:deploy-ios

# Full workflow (untested)
npm run release
```

## Working Directory Management

- Encountered issue where I was in `android/` subdirectory, causing ls commands to fail
- User noted this isn't the first time this has happened
- Reviewed `docs/claude-guide.md` which already documents best practices:
  1. Always prefer absolute paths
  2. Use subshells `(cd dir && command)` when directory change required
  3. Never use standalone `cd` unless chained with return
- Committed to following these rules more strictly going forward

## Files Modified/Created

**Fastlane Setup:**
- `Gemfile` - Added Fastlane dependency
- `fastlane/Fastfile` - Created comprehensive automation lanes
- `fastlane/Appfile` - Fixed bundle identifier
- `fastlane/README.md` - Auto-generated by Fastlane
- `app.json` - Fixed iOS bundle identifier
- `android/google-play-key.json` - Service account credentials
- `android/keystore.properties` - Fixed keystore path
- `ios/AuthKey_6ZN29XPT4Z.p8` - App Store Connect API key
- `.env.development` - Updated with all credentials
- `docs/FASTLANE_SETUP.md` - Comprehensive setup guide
- `package.json` - Added release scripts
- `android/app/build.gradle` - versionCode update (committed to main)

**Documentation Organization:**
- `CLAUDE.md` - Created primary startup file
- `.claude/PROJECT_CONTEXT.md` - Deduplicated, now reference-only
- `docs/work_journals/README.md` - Work journals purpose and format
- `docs/work_journals/jcksncllwy/2025-11-25.md` - Previous session history
- `docs/work_journals/jcksncllwy/2025-12-02.md` - Today's work (this file)
- `docs/claude-guide.md` - Removed (consolidated into CLAUDE.md)

## Documentation Organization

**Work Journals Structure**
- Created `docs/work_journals/` directory with subdirectories per contributor (GitHub username)
- Created `docs/work_journals/jcksncllwy/` for Jackson's work journals
- Moved session history from PROJECT_CONTEXT.md to dated journal files:
  - `2025-11-25.md` - v2.2.0 release and Atomic Design refactoring
  - `2025-12-02.md` - This file
- Created `docs/work_journals/README.md` explaining purpose and format
- Benefits: Prevents PROJECT_CONTEXT.md from becoming bloated, maintains detailed history

**Claude Code Configuration Consolidation**
- Created `CLAUDE.md` at project root (automatically read on startup)
- Consolidated into CLAUDE.md:
  - Critical rules from `docs/claude-guide.md` (working directory, GitHub CLI)
  - Active work and unclosed loops
  - Quick project overview and conventions
  - Team & security notes
  - Next steps
- Deduplicated `.claude/PROJECT_CONTEXT.md`:
  - Removed all sections duplicated in CLAUDE.md
  - Now contains only detailed reference material:
    * Architecture details
    * Full release process history
    * Android signing crisis details
    * Component organization
    * GitHub issues and technical debt
- Removed `docs/claude-guide.md` (now redundant)
- Benefits:
  - No duplicate information to maintain
  - Critical rules guaranteed to load every session
  - Net reduction of 112 lines
  - Clear separation: CLAUDE.md for startup, PROJECT_CONTEXT.md for reference

**Commits:**
1. `9cab6ea` - Add work journals directory structure
2. `fdbcb4b` - Consolidate Claude Code configuration into CLAUDE.md

## Git Worktrees & Gitignored Files

**Problem Identified:**
- Claude Code Desktop uses git worktrees for multi-instance sessions
- Git worktrees are separate directories that don't automatically copy gitignored files
- Main repo has `.env.development`, keystores, etc. that worktrees need for development
- Without these files, can't run app (no API_URL) or build releases (no signing keys)

**Solution Implemented:**
- Created `.claude/sync-worktree-files.sh` - smart sync script that:
  - Detects if running in a worktree vs main repo
  - Copies critical gitignored files from main repo to worktree:
    * `.env.development` (API URLs, Fastlane config)
    * `android/keystore.properties` (signing credentials)
    * `android/app/amplify-audiobooks-release.jks` (release keystore)
    * `android/app/upload_certificate.pem` (upload certificate)
  - Skips `.claude/settings.local.json` (worktree-specific permissions may differ)
  - Only runs when needed (checks git worktree list)

**Configuration:**
- Created `.claude/settings.json` (committed) with:
  - PATH configuration for Homebrew tools (fixes `gh` command availability)
  - SessionStart hook to run sync script automatically
- Updated `CLAUDE.md` to document the worktree sync system

**Testing:**
- ✅ Script successfully synced 4 files to current worktree
- ✅ `.env.development` now available (API_URL works)
- ✅ Android signing files present (builds will work)
- ✅ Auto-runs on session start via hook

**Commits:**
1. `86e448b` - Add automatic worktree gitignored file sync
2. `dc62fe9` - Document worktree gitignored file sync in CLAUDE.md

## Key Learnings

1. **Google Play API setup changed in 2025** - Now under "Users and permissions" not "API access"
2. **App-specific passwords have limitations** - Can't list builds, use API Key for full functionality
3. **App Store Connect API Key is superior** - Provides full programmatic access
4. **Don't override signing in Fastlane** - Use existing platform configurations (keystore.properties)
5. **Working directory discipline matters** - Follow absolute paths and subshell patterns
6. **Test incrementally** - Version bump → Build → Deploy (stopped before deploy for safety)
7. **Work journals prevent context bloat** - Separate dated journals from main context file
8. **CLAUDE.md auto-reads on startup** - Perfect for critical rules and active work
9. **Deduplication matters** - Don't maintain same info in multiple places
10. **Git worktrees don't copy gitignored files** - Need explicit sync mechanism for development files
11. **SessionStart hooks enable automation** - Perfect for worktree initialization tasks
12. **Claude Code Desktop PATH is restricted** - Must configure in settings.json or CLAUDE_ENV_FILE
